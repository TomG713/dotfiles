#!/bin/bash

# External Monitor Wake Script
# This script forces the detection of external monitors on wake and allows manual execution.

#xrandr | grep ' connected'
#https://askubuntu.com/a/1427781

LOGFILE="/var/log/external_monitor_wake.log"

echo "------------------------------------------------------------" >> $LOGFILE
echo "$(date) - Manual execution requested" >> $LOGFILE

echo "$(date) - Enabling NVIDIA persistence mode..." >> $LOGFILE
sudo nvidia-smi -pm 1 >> $LOGFILE 2>&1
echo "$(date) - Persistence mode enabled successfully." >> $LOGFILE

echo "$(date) - Resetting display configuration..." >> $LOGFILE
xrandr --auto >> $LOGFILE 2>&1
echo "$(date) - xrandr output:" >> $LOGFILE
xrandr >> $LOGFILE 2>&1

echo "$(date) - Forcing full composition pipeline for NVIDIA..." >> $LOGFILE
sudo nvidia-settings --assign CurrentMetaMode="DP-4-1-5: nvidia-auto-select +1920+0 { ForceCompositionPipeline = On }" >> $LOGFILE 2>&1

if [ $? -eq 0 ]; then
    echo "$(date) - Full composition pipeline forced successfully." >> $LOGFILE
else
    echo "$(date) - Failed to force full composition pipeline." >> $LOGFILE
fi

echo "$(date) - Waking up external monitor..." >> $LOGFILE

for i in {1..3}; do
    echo "$(date) - Attempt $i: Enabling DP-4-1-5..." >> $LOGFILE
    xrandr --output DP-4-1-5 --auto --right-of eDP-1 --primary >> $LOGFILE 2>&1
#    xset dpms force off
#    sleep 2
#    xset dpms force on
    if xrandr | grep -q "DP-4-1-5 connected"; then
        echo "$(date) - External monitor detected and enabled." >> $LOGFILE
        break
    else
        echo "$(date) - External monitor not detected." >> $LOGFILE
    fi
done

echo "$(date) - Final xrandr output:" >> $LOGFILE
xrandr >> $LOGFILE 2>&1
echo "------------------------------------------------------------" >> $LOGFILE
echo "$(date) - End of script execution" >> $LOGFILE









