#!/bin/bash

# External Monitor Wake Script
# This script forces the detection of external monitors on wake and allows manual execution.

#xrandr | grep ' connected'
#https://askubuntu.com/a/1427781


LOG_FILE="/var/log/external_monitor_wake.log"

log() {
    echo "$(date +'%Y-%m-%d %H:%M:%S') - $1" | tee -a $LOG_FILE
}

log_xrandr() {
    xrandr_output=$(xrandr)
    log "xrandr output: $xrandr_output"
}

reset_gpu() {
    log "Resetting GPU..."
    xrandr --setprovideroutputsource modesetting NVIDIA-0
    sleep 2
    log_xrandr
}

wake_monitor() {
    log "Waking up external monitor..."
    DISPLAY=:1; export DISPLAY
    
    for i in {1..5}; do
        xrandr --output DP-4-1-5 --off
        sleep 2
        xrandr --output DP-4-1-5 --auto --right-of eDP-1 --primary
        xset dpms force off
        sleep 5
        xset dpms force on
        xrandr --output DP-4-1-5 --mode 3840x2160 --rate 30 --right-of eDP-1 --primary
        
        log_xrandr
        
        if xrandr | grep -q 'DP-4-1-5 connected'; then
            log "External monitor successfully detected and configured."
            return 0
        else
            log "Attempt $i: External monitor not detected, retrying..."
            sleep 2
        fi
    done
    
    log "Failed to detect the external monitor after multiple attempts."
    return 1
}

reset_display() {
    log "Resetting display configuration..."
    xrandr --auto
    sleep 2
    log_xrandr
}

case "$1" in
    suspend | hibernate | pre)
        log "System is going to $1"
        ;;
    resume | thaw | post)
        log "System is waking up from $1"
        reset_gpu
        reset_display
        wake_monitor
        ;;
    manual)
        log "Manual execution requested"
        reset_gpu
        reset_display
        wake_monitor
        ;;
    *)
        echo "Usage: $0 {suspend|hibernate|pre|resume|thaw|post|manual}"
        exit 1
        ;;
esac

exit 0
